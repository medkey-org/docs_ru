---
description: >-
  Как использовать бизнес-процессы в работе медицинской информационной системы
  Медкей
---

# Конструктор бизнес-процессов

## Общие сведения о функциональности бизнес-процессов

Бизнес-процессы позволяют настроить жизненные циклы сущностей, и в дальнейшем использовать данные жизненные циклы для различных действий с сущностями. 

У функциональности бизнес-процессов два основных сценария применения:

1. Организация переходов между статусами сущности любой сложноси
2. Выполнение операций по нажатию кнопки, которые добавляются через код в хендлерах

## Настройка бизнес-процесса на примере сущности «Заказ» \(Order\)

Например, мы хотим настроить следующий жизненный цикл для сущности "Заказ": статус «Новый» → статус «Оплачен».

Переходим в пункт меню _«Настройки» → «Статусы бизнес-процессов»_. Создаём 2 статуса для сущности `Order` \(столбец ORM\) модуля `crm` \(столбец таблицы «Модуль»\):

![&#x421;&#x43F;&#x438;&#x441;&#x43E;&#x43A; &#x441;&#x442;&#x430;&#x442;&#x443;&#x441;&#x43E;&#x432;, &#x434;&#x43E;&#x431;&#x430;&#x432;&#x43B;&#x435;&#x43D;&#x43D;&#x44B;&#x445; &#x434;&#x43B;&#x44F; ORM Order &#x432; &#x43C;&#x43E;&#x434;&#x443;&#x43B;&#x435; crm ](../.gitbook/assets/image%20%286%29.png)

Переходим в пункт меню _«Настройки» → «Конструктор бизнес-процессов»_. Создаём новый бизнес-процесс, редактируем его и переводим в статус «На редактировании»:

![&#x424;&#x43E;&#x440;&#x43C;&#x430; &#x440;&#x435;&#x434;&#x430;&#x43A;&#x442;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x44F; &#x431;&#x438;&#x437;&#x43D;&#x435;&#x441;-&#x43F;&#x440;&#x43E;&#x446;&#x435;&#x441;&#x441;&#x430; &#x441; &#x443;&#x441;&#x442;&#x430;&#x43D;&#x43E;&#x432;&#x43B;&#x435;&#x43D;&#x43D;&#x44B;&#x43C; &#x441;&#x442;&#x430;&#x442;&#x443;&#x441;&#x43E;&#x43C; &#xAB;&#x41D;&#x430; &#x440;&#x435;&#x434;&#x430;&#x43A;&#x442;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x438;&#xBB;](../.gitbook/assets/image%20%285%29.png)

Переходим в карточку бизнес-процесса \(по ссылке в списке по названию бизнес-процесса\) и через кнопку добавления заполняем необходимые нам переходы. При создании перехода необходимо указать начальный и конечный статусы, а также можно выбрать выполняемые действия \(если они реализованы для указанной сущности в каталоге `handlers` в модуле\):

![&#x41F;&#x430;&#x440;&#x430;&#x43C;&#x435;&#x442;&#x440;&#x44B;, &#x43A;&#x43E;&#x442;&#x43E;&#x440;&#x44B;&#x435; &#x43C;&#x43E;&#x436;&#x43D;&#x43E; &#x443;&#x43A;&#x430;&#x437;&#x430;&#x442;&#x44C; &#x43F;&#x440;&#x438; &#x441;&#x43E;&#x437;&#x434;&#x430;&#x43D;&#x438;&#x438; &#x43F;&#x435;&#x440;&#x435;&#x445;&#x43E;&#x434;&#x430; &#x431;&#x438;&#x437;&#x43D;&#x435;&#x441;-&#x43F;&#x440;&#x43E;&#x446;&#x435;&#x441;&#x441;&#x430;](../.gitbook/assets/image.png)

Например, для заказа мы добавили переход между статусами `NEW` и `PAID`. В интерфейсе кнопка, осуществляющая данный переход, будет называться «Оплата заказа»:

![&#x41D;&#x430;&#x441;&#x442;&#x440;&#x43E;&#x435;&#x43D;&#x43D;&#x44B;&#x435; &#x43F;&#x435;&#x440;&#x435;&#x445;&#x43E;&#x434;&#x44B; &#x431;&#x438;&#x437;&#x43D;&#x435;&#x441;-&#x43F;&#x440;&#x43E;&#x446;&#x435;&#x441;&#x441;&#x430;](../.gitbook/assets/image%20%287%29.png)



Возвращаемся в список бизнес-процессов, меняем статус бизнес-процесса с «На редактировании» в «Активен».

После выполнения данного действия бизнес-процесс будет доступен для выполнения над сущностями. На примере заказа:

![&#x412;&#x44B;&#x43F;&#x43E;&#x43B;&#x43D;&#x435;&#x43D;&#x438;&#x44F; &#x434;&#x435;&#x439;&#x441;&#x442;&#x432;&#x438;&#x44F;, &#x43D;&#x430;&#x441;&#x442;&#x440;&#x43E;&#x435;&#x43D;&#x43D;&#x43E;&#x433;&#x43E; &#x432; &#x43A;&#x43E;&#x43D;&#x441;&#x442;&#x440;&#x443;&#x43A;&#x442;&#x43E;&#x440;&#x435; &#x431;&#x438;&#x437;&#x43D;&#x435;&#x441;-&#x43F;&#x440;&#x43E;&#x446;&#x435;&#x441;&#x441;&#x43E;&#x432;](../.gitbook/assets/image%20%289%29.png)

![&#x420;&#x435;&#x437;&#x443;&#x43B;&#x44C;&#x442;&#x430;&#x442; &#x432;&#x44B;&#x43F;&#x43E;&#x43B;&#x43D;&#x435;&#x43D;&#x438;&#x44F; &#x434;&#x435;&#x439;&#x441;&#x442;&#x432;&#x438;&#x44F;](../.gitbook/assets/image%20%281%29.png)

## Добавление обработчиков, выполняемых при переходе сущности

Для расширения функциональности можно добавить дополнительные обработчики, реализованные на языке PHP. Обработчик — это класс, объединяющий методы, принимающие модель сущности и выполняющие с ней какие-либо манипуляции.

В каталоге модуля \(`modules/<modulename>`\) добавляем каталог `handlers` \(если он отсутствует\). В каталоге создаём 2 файла:

* Файл PHP-класса;
* Файл PHP-интерфейса.

![&#x424;&#x430;&#x439;&#x43B;&#x44B; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x430; &#x43D;&#x430; &#x43F;&#x440;&#x438;&#x43C;&#x435;&#x440;&#x435; &#x43E;&#x431;&#x440;&#x430;&#x431;&#x43E;&#x442;&#x447;&#x438;&#x43A;&#x430; OrderHandler &#x43C;&#x43E;&#x434;&#x443;&#x43B;&#x44F; crm](../.gitbook/assets/image%20%2811%29.png)

В интерфейсе описываем методы, которые планируем реализовать в обработчике \(они в дальнейшем будут доступны в форме выбора метода класса-обработчика\):

```php
<?php
namespace app\modules\crm\handlers;

use Symfony\Component\Workflow\Event\Event;

/**
 * Interface OrderStateSubscriberInterface
 * @package Module\CRM
 * @copyright 2012-2019 Medkey
 */
interface OrderHandlerInterface
{
    public function onPaid(Event $e);
}

```

После описания интерфейса реализуем логику, которую выполняем над сущностью. В качестве входного параметра нам приходит экземпляр события `Event`, у которого имеется метод `getSubject`. Данный метод содержит данные модели, которые мы можем определённым образом обработать:

```php
<?php
namespace app\modules\crm\handlers;

use app\common\dto\Dto;
use app\modules\crm\models\orm\Order;
use app\modules\medical\application\ReferralServiceInterface;
use Symfony\Component\Workflow\Event\Event;

/**
 * Class OrderStateSubscriber
 * @package Module\CRM
 * @copyright 2012-2019 Medkey
 */
class OrderHandler implements OrderHandlerInterface
{
    public function onPaid(Event $e)
    {
        /** @var Order $order */
        $order = $e->getSubject();
        $o = $order->toArray([], ['orderItems']);
        $orderDto = Dto::make($o);
        /** @var ReferralServiceInterface $referralAppService */
        $referralAppService = \Yii::$container->get(ReferralServiceInterface::class);
        $referralAppService->generateReferralByOrder($orderDto);
    }
}

```

После этого необходимо зарегистрировать добавленный обработчик в Bootstrap-классе модуля:

```php
<?php
namespace app\modules\crm;

...
use app\modules\crm\handlers\OrderHandler;
use app\modules\crm\handlers\OrderHandlerInterface;
use yii\base\BootstrapInterface;

/**
 * Class Bootstrap
 * @package Module\CRM
 * @copyright 2012-2019 Medkey
 */
class Bootstrap implements BootstrapInterface
{
    /**
     * @inheritdoc
     */
    public function bootstrap($app)
    {
        \Yii::$container->setSingletons([
            ...
            OrderHandlerInterface::class => OrderHandler::class,
            ...
        ]);
    }
}

```

После выполнения данных действий обработчик и его методы будут доступны в конструкторе бизнес-процессов.

